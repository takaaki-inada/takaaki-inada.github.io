<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFÂãïÁîª‰ΩúÊàê„ÉÑ„Éº„É´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .section:hover {
            transform: translateY(-2px);
        }
        
        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
        }
        
        .file-input {
            width: 100%;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .file-input:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-input.drag-over {
            border-color: #667eea;
            background: #e8f2ff;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .file-input.drag-over .file-input-text {
            color: #667eea;
            font-weight: 600;
        }
        
        .file-input input {
            display: none !important;
        }
        
        .file-input-text {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            resize: vertical;
            transition: all 0.3s ease;
            position: relative;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea.drag-over {
            border-color: #667eea;
            background: #f8fbff;
            transform: scale(1.01);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .preview {
            margin-top: 30px;
            text-align: center;
        }
        
        .preview video {
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }
        
        .file-item {
            padding: 8px 12px;
            background: white;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            margin-bottom: -2px;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .url-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .load-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .load-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .load-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .global-drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.1);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .global-drop-overlay.active {
            display: flex;
        }
        
        .drop-message {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
            border: 3px dashed #667eea;
        }
    </style>
</head>
<body>
    <!-- „Ç∞„É≠„Éº„Éê„É´„Éâ„É≠„ÉÉ„Éó„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="globalDropOverlay" class="global-drop-overlay">
        <div class="drop-message">
            üìÅ „Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        </div>
    </div>
    
    <div class="container">
        <h1>üìΩÔ∏è PDFÂãïÁîª‰ΩúÊàê„ÉÑ„Éº„É´</h1>
        
        <div class="section">
            <h2>
                <span class="icon">üìÑ</span>
                PDF„Éï„Ç°„Ç§„É´ („Çπ„É©„Ç§„Éâ)
            </h2>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('file')">üìÅ „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
                <button class="tab" onclick="switchTab('url')">üîó Google„Çπ„É©„Ç§„ÉâURL</button>
            </div>
            
            <div id="fileTab" class="tab-content active">
                <div class="file-input" onclick="document.getElementById('pdfFile').click()">
                    <input type="file" id="pdfFile" accept="application/pdf,.pdf" />
                    <div class="file-input-text">üìÅ PDF„Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åã„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</div>
                </div>
            </div>
            
            <div id="urlTab" class="tab-content">
                <input type="url" class="url-input" id="pdfUrl" placeholder="https://docs.google.com/presentation/d/your-slide-id/edit „Åæ„Åü„ÅØ export?format=pdf" />
                <button class="load-btn" id="loadUrlBtn" onclick="loadPdfFromUrl()">üì• PDFÂá∫ÂäõURL„ÇíÁîüÊàê„ÉªÂèñÂæó</button>
                <div style="margin-top: 10px; font-size: 12px; color: #666; line-height: 1.4;">
                    üí° „Éí„É≥„Éà: Google„Çπ„É©„Ç§„Éâ„ÅÆURL„ÇíÂÖ•Âäõ„Åô„Çã„Å®„ÄÅPDFÂá∫ÂäõÁî®„ÅÆURL„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ<br>
                    CORSÂà∂Èôê„Å´„Çà„Çä„ÄÅÁîüÊàê„Åï„Çå„ÅüURL„Åã„ÇâÊâãÂãï„ÅßPDF„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„ÄÅ„Äå„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Äç„Çø„Éñ„Åß„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                </div>
            </div>
            
            <div id="pdfFileName" class="file-list" style="display: none;"></div>
            <div id="slidePreview" class="file-list" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>
                <span class="icon">üéµ</span>
                Èü≥Â£∞„Éï„Ç°„Ç§„É´ (MP3)
            </h2>
            <div class="file-input" onclick="document.getElementById('audioFile').click()">
                <input type="file" id="audioFile" accept="audio/mp3,.mp3" />
                <div class="file-input-text">üé∂ MP3Èü≥Â£∞„Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åã„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</div>
            </div>
            <div id="audioFileName" class="file-list" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>
                <span class="icon">‚è±Ô∏è</span>
                „Çø„Ç§„Éü„É≥„Ç∞ÊÉÖÂ†± (JSON)
            </h2>
            <textarea id="timingJson" placeholder='[
  {"start_ms": 0, "end_ms": 3000},
  {"start_ms": 3000, "end_ms": 6000},
  {"start_ms": 6000, "end_ms": 9000}
]

ÂêÑ„Çπ„É©„Ç§„Éâ„ÅÆÈñãÂßãÊôÇÈñì(start_ms)„Å®ÁµÇ‰∫ÜÊôÇÈñì(end_ms)„Çí„Éü„É™Áßí„ÅßÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
üí° JSON„Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åó„Å¶Ë™≠„ÅøËæº„ÇÄ„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ'></textarea>
        </div>
        
        <button class="btn" id="createVideoBtn" onclick="createVideo()">
            üé¨ ÂãïÁîª„Çí‰ΩúÊàê„Åô„Çã
        </button>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="status"></div>
        
        <div class="preview" id="preview" style="display: none;">
            <h2>„Éó„É¨„Éì„É•„Éº</h2>
            <video controls id="videoPreview"></video>
            <br><br>
            <a id="downloadLink" class="btn" style="display: none; text-decoration: none;">
                üíæ ÂãïÁîª„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            </a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let pdfFile = null;
        let slideImages = [];
        let audioFile = null;
        let currentPdfSource = null; // 'file' or 'url'
        
        function switchTab(tabType) {
            // „Çø„Éñ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            if (tabType === 'file') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('fileTab').classList.add('active');
            } else if (tabType === 'url') {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('urlTab').classList.add('active');
            }
        }
        
        async function loadPdfFromUrl() {
            const urlInput = document.getElementById('pdfUrl');
            const loadBtn = document.getElementById('loadUrlBtn');
            const url = urlInput.value.trim();
            
            if (!url) {
                showStatus('‚ùå URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            // URL„ÅÆÂΩ¢Âºè„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (!url.includes('docs.google.com')) {
                showStatus('‚ùå Google„Çπ„É©„Ç§„Éâ„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            try {
                loadBtn.disabled = true;
                loadBtn.textContent = 'üì• Ë™≠„ÅøËæº„Åø‰∏≠...';
                showStatus('üîó URL„Åã„ÇâPDF„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info');
                
                // Google„Çπ„É©„Ç§„Éâ„ÅÆURL„ÇíPDFÂá∫ÂäõURL„Å´Â§âÊèõ
                let pdfUrl = url;
                if (url.includes('/edit')) {
                    // Á∑®ÈõÜURL„ÅÆÂ†¥Âêà„ÄÅPDFÂá∫ÂäõURL„Å´Â§âÊèõ
                    const slideId = url.match(/\/presentation\/d\/([a-zA-Z0-9-_]+)/);
                    if (slideId) {
                        pdfUrl = `https://docs.google.com/presentation/d/${slideId[1]}/export?format=pdf`;
                    }
                }
                
                // „Éñ„É©„Ç¶„Ç∂„ÅßPDF„ÇíÁõ¥Êé•ÂèñÂæó„ÇíË©¶„Åø„Çã
                try {
                    const response = await fetch(pdfUrl, {
                        mode: 'no-cors'
                    });
                    
                    // no-cors„É¢„Éº„Éâ„Åß„ÅØÊàêÂäü„Åó„Åü„Åã„Å©„ÅÜ„Åã„Çè„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ
                    // „Çà„ÇäÁõ¥Êé•ÁöÑ„Å™ÊñπÊ≥ï„ÇíÊ°àÂÜÖ
                    showStatus('‚ÑπÔ∏è CORSÂà∂Èôê„Å´„Çà„Çä„ÄÅ‰ª•‰∏ã„ÅÆÊâãÈ†Ü„ÅßPDF„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n1. ‰∏äË®ò„ÅÆURL„Çí„Éñ„É©„Ç¶„Ç∂„ÅßÈñã„Åè\n2. PDF„Åå„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åï„Çå„Åü„Çâ„ÄÅ„Äå„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Äç„Çø„Éñ„Åß„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ', 'info');
                    
                    // URL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                    try {
                        await navigator.clipboard.writeText(pdfUrl);
                        showStatus('‚úÖ PDFÂá∫ÂäõURL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„ÅÑ„Å¶PDF„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
                    } catch (e) {
                        console.log('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó:', e);
                    }
                    
                    // Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßPDF„ÇíÈñã„Åè
                    window.open(pdfUrl, '_blank');
                    
                } catch (fetchError) {
                    console.error('Fetch error:', fetchError);
                    
                    // „Éï„Çß„ÉÉ„ÉÅ„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÇÇ„ÄÅURL„ÇíÊèê‰æõ
                    showStatus('‚ÑπÔ∏è Áõ¥Êé•ÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ‰ª•‰∏ã„ÅÆÊâãÈ†Ü„ÅßPDF„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n1. ‰∏ãË®òURL„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè\n2. PDF„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ\n3. „Äå„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Äç„Çø„Éñ„Åß„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ', 'info');
                    
                    // URL„ÇíË°®Á§∫
                    const pdfFileName = document.getElementById('pdfFileName');
                    pdfFileName.style.display = 'block';
                    pdfFileName.innerHTML = `
                        <div class="file-item" style="flex-direction: column; align-items: flex-start;">
                            <div style="margin-bottom: 10px;">üìã PDFÂá∫ÂäõURL:</div>
                            <div style="word-break: break-all; background: #f0f0f0; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                                ${pdfUrl}
                            </div>
                            <button onclick="window.open('${pdfUrl}', '_blank')" style="margin-top: 8px; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üìÇ Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå URLÂá¶ÁêÜ„Ç®„É©„Éº:', error);
                showStatus(`‚ùå URLÂá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`, 'error');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'üì• URL„Åã„ÇâPDF„ÇíË™≠„ÅøËæº„Åø';
            }
        }
        
        document.getElementById('pdfFile').addEventListener('change', function(e) {
            pdfFile = e.target.files[0];
            currentPdfSource = 'file';
            updatePdfFileName();
            if (pdfFile) {
                processPDF();
            }
        });
        
        document.getElementById('audioFile').addEventListener('change', function(e) {
            audioFile = e.target.files[0];
            updateAudioFileName();
        });
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ
        initializeDragAndDrop();
        
        function initializeDragAndDrop() {
            // „Ç∞„É≠„Éº„Éê„É´„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
            initializeGlobalDragAndDrop();
            
            // PDF„Éï„Ç°„Ç§„É´Áî®„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
            const pdfDropZone = document.querySelector('#fileTab .file-input');
            setupDragAndDrop(pdfDropZone, 'pdf', handlePdfDrop);
            
            // Èü≥Â£∞„Éï„Ç°„Ç§„É´Áî®„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
            const audioDropZone = document.querySelector('.section:nth-child(3) .file-input');
            setupDragAndDrop(audioDropZone, 'audio', handleAudioDrop);
            
            // JSON„Éï„Ç°„Ç§„É´Áî®„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÔºàtextareaÔºâ
            const jsonDropZone = document.getElementById('timingJson');
            setupDragAndDrop(jsonDropZone, 'json', handleJsonDrop);
        }
        
        function initializeGlobalDragAndDrop() {
            const overlay = document.getElementById('globalDropOverlay');
            let dragCounter = 0;
            
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„Å∏„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
            document.addEventListener('dragenter', function(e) {
                e.preventDefault();
                dragCounter++;
                if (dragCounter === 1) {
                    overlay.classList.add('active');
                }
            });
            
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„Åã„Çâ„ÅÆ„Éâ„É©„ÉÉ„Ç∞Èõ¢ËÑ±
            document.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) {
                    overlay.classList.remove('active');
                }
            });
            
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„Åß„ÅÆ„Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„Éº
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„Åß„ÅÆ„Éâ„É≠„ÉÉ„Éó
            document.addEventListener('drop', function(e) {
                e.preventDefault();
                dragCounter = 0;
                overlay.classList.remove('active');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleGlobalFileDrop(files[0]);
                }
            });
        }
        
        function handleGlobalFileDrop(file) {
            const fileName = file.name.toLowerCase();
            const fileType = file.type;
            
            if (fileName.endsWith('.pdf') || fileType.includes('pdf')) {
                handlePdfDrop(file);
            } else if (fileName.endsWith('.mp3') || fileType.includes('audio')) {
                handleAudioDrop(file);
            } else if (fileName.endsWith('.json') || fileName.endsWith('.txt') || fileType.includes('json') || fileType.includes('text')) {
                handleJsonDrop(file);
            } else {
                showStatus('‚ùå „Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô„ÄÇPDF„ÄÅMP3„ÄÅ„Åæ„Åü„ÅØJSON„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
            }
        }
        
        function setupDragAndDrop(dropZone, fileType, handleDrop) {
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆÂ§ñ„Å´Âá∫„ÅüÊôÇ„ÅÆ„Åø„ÇØ„É©„Çπ„ÇíÂâäÈô§
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                }
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleDrop(files[0]);
                }
            });
        }
        
        function handlePdfDrop(file) {
            // PDF„Éï„Ç°„Ç§„É´„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
                showStatus('‚ùå PDF„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            pdfFile = file;
            currentPdfSource = 'file';
            updatePdfFileName();
            
            // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà
            switchTab('file');
            
            showStatus('‚úÖ PDF„Éï„Ç°„Ç§„É´„Åå„Éâ„É≠„ÉÉ„Éó„Åï„Çå„Åæ„Åó„Åü', 'success');
            processPDF();
        }
        
        function handleAudioDrop(file) {
            // MP3„Éï„Ç°„Ç§„É´„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (!file.type.includes('audio') && !file.name.toLowerCase().endsWith('.mp3')) {
                showStatus('‚ùå MP3Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            audioFile = file;
            updateAudioFileName();
            showStatus('‚úÖ Èü≥Â£∞„Éï„Ç°„Ç§„É´„Åå„Éâ„É≠„ÉÉ„Éó„Åï„Çå„Åæ„Åó„Åü', 'success');
        }
        
        function handleJsonDrop(file) {
            // JSON„Åæ„Åü„ÅØ„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (!file.type.includes('json') && !file.type.includes('text') && 
                !file.name.toLowerCase().endsWith('.json') && 
                !file.name.toLowerCase().endsWith('.txt')) {
                showStatus('‚ùå JSON„Åæ„Åü„ÅØ„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    // JSON„ÅÆÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
                    JSON.parse(content);
                    document.getElementById('timingJson').value = content;
                    showStatus('‚úÖ „Çø„Ç§„Éü„É≥„Ç∞ÊÉÖÂ†±„Éï„Ç°„Ç§„É´„ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü', 'success');
                } catch (error) {
                    // JSONÂΩ¢Âºè„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åù„ÅÆ„Åæ„Åæ„ÉÜ„Ç≠„Çπ„Éà„Å®„Åó„Å¶ÊåøÂÖ•
                    document.getElementById('timingJson').value = content;
                    showStatus('‚ö†Ô∏è „Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÅåÊåøÂÖ•„Åï„Çå„Åæ„Åó„ÅüÔºàJSONÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ', 'info');
                }
            };
            reader.readAsText(file);
        }
        
        async function processPDF() {
            if (pdfFile) {
                await processPDFFromFile(pdfFile);
            }
        }
        
        async function processPDFFromFile(file) {
            const arrayBuffer = await file.arrayBuffer();
            await processPDFFromBuffer(arrayBuffer, file.name);
        }
        
        async function processPDFFromBlob(blob, filename) {
            const arrayBuffer = await blob.arrayBuffer();
            await processPDFFromBuffer(arrayBuffer, filename);
        }
        
        async function processPDFFromBuffer(arrayBuffer, filename) {
            try {
                console.log('üìÑ PDF„Éï„Ç°„Ç§„É´„ÅÆÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åô:', filename);
                showStatus('üìÑ PDF„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...', 'info');
                
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const numPages = pdf.numPages;
                
                console.log(`üìä PDF„Éö„Éº„Ç∏Êï∞: ${numPages}`);
                showStatus(`üìä ${numPages}„Éö„Éº„Ç∏„ÅÆPDF„ÇíÂá¶ÁêÜ‰∏≠...`, 'info');
                
                slideImages = [];
                const slidePreview = document.getElementById('slidePreview');
                slidePreview.innerHTML = '';
                slidePreview.style.display = 'block';
                
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    console.log(`üîÑ „Éö„Éº„Ç∏ ${pageNum}/${numPages} „ÇíÂá¶ÁêÜ‰∏≠...`);
                    showStatus(`üîÑ „Éö„Éº„Ç∏ ${pageNum}/${numPages} „ÇíPNGÂ§âÊèõ‰∏≠...`, 'info');
                    
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 2.0 });
                    
                    // Canvas‰ΩúÊàê
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    // PDF„Éö„Éº„Ç∏„ÇíCanvas„Å´„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    }).promise;
                    
                    // Canvas„ÇíBlob„Å´Â§âÊèõ
                    const blob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/png');
                    });
                    
                    slideImages.push(blob);
                    
                    // „Éó„É¨„Éì„É•„ÉºÁî®„Çµ„É†„Éç„Ç§„É´‰ΩúÊàê
                    const thumbnailCanvas = document.createElement('canvas');
                    const thumbnailCtx = thumbnailCanvas.getContext('2d');
                    const thumbnailScale = 150 / Math.max(viewport.width, viewport.height);
                    thumbnailCanvas.width = viewport.width * thumbnailScale;
                    thumbnailCanvas.height = viewport.height * thumbnailScale;
                    
                    thumbnailCtx.drawImage(canvas, 0, 0, thumbnailCanvas.width, thumbnailCanvas.height);
                    
                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'file-item';
                    thumbnailDiv.style.display = 'flex';
                    thumbnailDiv.style.alignItems = 'center';
                    thumbnailDiv.style.gap = '10px';
                    thumbnailDiv.innerHTML = `
                        <span>üìÑ „Çπ„É©„Ç§„Éâ ${pageNum}</span>
                        <span style="font-size: 12px; color: #888;">${canvas.width}√ó${canvas.height}px</span>
                    `;
                    thumbnailDiv.appendChild(thumbnailCanvas);
                    thumbnailCanvas.style.borderRadius = '4px';
                    slidePreview.appendChild(thumbnailDiv);
                    
                    console.log(`‚úÖ „Éö„Éº„Ç∏ ${pageNum} ÂÆå‰∫Ü (${canvas.width}√ó${canvas.height}px)`);
                }
                
                console.log(`üéâ PDFÂá¶ÁêÜÂÆå‰∫Ü: ${slideImages.length}Êûö„ÅÆ„Çπ„É©„Ç§„ÉâÁîªÂÉè„ÇíÁîüÊàê`);
                showStatus(`‚úÖ PDFÂá¶ÁêÜÂÆå‰∫Ü: ${slideImages.length}Êûö„ÅÆ„Çπ„É©„Ç§„Éâ„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü`, 'success');
                
            } catch (error) {
                console.error('‚ùå PDFÂá¶ÁêÜ„Ç®„É©„Éº:', error);
                showStatus(`‚ùå PDFÂá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }
        
        function updatePdfFileName(filename = null, filesize = null) {
            const pdfFileName = document.getElementById('pdfFileName');
            if (currentPdfSource === 'file' && pdfFile) {
                pdfFileName.style.display = 'block';
                pdfFileName.innerHTML = `<div class="file-item">üìÑ ${pdfFile.name} (${Math.round(pdfFile.size/1024)}KB)</div>`;
            } else if (currentPdfSource === 'url' && filename) {
                pdfFileName.style.display = 'block';
                const sizeText = filesize ? `(${Math.round(filesize/1024)}KB)` : '';
                pdfFileName.innerHTML = `<div class="file-item">üìÑ ${filename} ${sizeText}</div>`;
            } else {
                pdfFileName.style.display = 'none';
            }
        }
        
        function updateAudioFileName() {
            const audioFileName = document.getElementById('audioFileName');
            if (audioFile) {
                audioFileName.style.display = 'block';
                audioFileName.innerHTML = `<div class="file-item">üéµ ${audioFile.name} (${Math.round(audioFile.size/1024)}KB)</div>`;
            } else {
                audioFileName.style.display = 'none';
            }
        }
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateProgress(percent) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';
        }
        
        async function createVideo() {
            try {
                console.log('üé¨ ÂãïÁîª‰ΩúÊàêÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åô');
                
                // ÂÖ•Âäõ„ÉÅ„Çß„ÉÉ„ÇØ
                if (slideImages.length === 0) {
                    console.error('‚ùå „Çπ„É©„Ç§„ÉâÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    showStatus('‚ùå PDF„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Çπ„É©„Ç§„Éâ„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    return;
                }
                
                if (!audioFile) {
                    console.error('‚ùå Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    showStatus('‚ùå Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    return;
                }
                
                let timing;
                try {
                    timing = JSON.parse(document.getElementById('timingJson').value);
                    console.log('üìã „Çø„Ç§„Éü„É≥„Ç∞ÊÉÖÂ†±:', timing);
                } catch (e) {
                    console.error('‚ùå JSONËß£Êûê„Ç®„É©„Éº:', e);
                    showStatus('‚ùå „Çø„Ç§„Éü„É≥„Ç∞ÊÉÖÂ†±„ÅÆJSON„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
                    return;
                }
                
                if (!Array.isArray(timing) || timing.length !== slideImages.length) {
                    console.error(`‚ùå „Çø„Ç§„Éü„É≥„Ç∞Êï∞(${timing.length})„Å®„Çπ„É©„Ç§„ÉâÊï∞(${slideImages.length})„Åå‰∏ç‰∏ÄËá¥`);
                    showStatus(`‚ùå „Çø„Ç§„Éü„É≥„Ç∞ÊÉÖÂ†±„ÅÆÊï∞(${timing.length})„Å®„Çπ„É©„Ç§„ÉâÊï∞(${slideImages.length})„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì„ÄÇ`, 'error');
                    return;
                }
                
                // start_ms, end_ms„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆÁ¢∫Ë™ç
                const hasValidTiming = timing.every(t => 
                    typeof t.start_ms === 'number' && typeof t.end_ms === 'number'
                );
                if (!hasValidTiming) {
                    console.error('‚ùå „Çø„Ç§„Éü„É≥„Ç∞ÊÉÖÂ†±„Å´start_ms„Åæ„Åü„ÅØend_ms„Åå‰∏çË∂≥');
                    showStatus('‚ùå „Çø„Ç§„Éü„É≥„Ç∞ÊÉÖÂ†±„Å´start_ms„Å®end_ms„ÇíÊ≠£„Åó„ÅèË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    return;
                }
                
                const createBtn = document.getElementById('createVideoBtn');
                createBtn.disabled = true;
                createBtn.innerHTML = 'üé¨ ÂãïÁîª‰ΩúÊàê‰∏≠...';
                
                console.log('üé¨ ÂãïÁîª‰ΩúÊàê„ÇíÈñãÂßã„Åó„Åæ„Åô...');
                showStatus('üé¨ ÂãïÁîª‰ΩúÊàê„ÇíÈñãÂßã„Åó„Åæ„Åô...', 'info');
                updateProgress(0);
                
                // CanvasË®≠ÂÆö
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // ÊúÄÂàù„ÅÆÁîªÂÉè„Çí„É≠„Éº„Éâ„Åó„Å¶„Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„ÇíË™øÊï¥
                console.log('üñºÔ∏è ÊúÄÂàù„ÅÆ„Çπ„É©„Ç§„ÉâÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                const firstImg = new Image();
                await new Promise((resolve, reject) => {
                    firstImg.onload = resolve;
                    firstImg.onerror = reject;
                    firstImg.src = URL.createObjectURL(slideImages[0]);
                });
                
                canvas.width = firstImg.width;
                canvas.height = firstImg.height;
                console.log(`üìê „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫: ${canvas.width}√ó${canvas.height}`);
                
                updateProgress(10);
                
                // MediaRecorder setup
                console.log('üìπ „Éì„Éá„Ç™„Çπ„Éà„É™„Éº„É†„ÇíÂàùÊúüÂåñ‰∏≠...');
                const stream = canvas.captureStream(30); // 30fps
                
                // Èü≥Â£∞„Çπ„Éà„É™„Éº„É†„ÇíËøΩÂä†
                console.log('üéµ Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÊ∫ñÂÇô‰∏≠...');
                const audioElement = new Audio();
                audioElement.src = URL.createObjectURL(audioFile);
                
                await new Promise((resolve, reject) => {
                    audioElement.oncanplaythrough = () => {
                        console.log(`üéµ Èü≥Â£∞„Éï„Ç°„Ç§„É´Ê∫ñÂÇôÂÆå‰∫Ü: ${audioElement.duration}Áßí`);
                        resolve();
                    };
                    audioElement.onerror = reject;
                    audioElement.load();
                });
                
                // AudioContext„ÅßÈü≥Â£∞„Çπ„Éà„É™„Éº„É†„Çí‰ΩúÊàê
                console.log('üîä AudioContextÂàùÊúüÂåñ‰∏≠...');
                const audioContext = new AudioContext();
                const source = audioContext.createMediaElementSource(audioElement);
                const dest = audioContext.createMediaStreamDestination();
                source.connect(dest);
                source.connect(audioContext.destination);
                
                // Èü≥Â£∞„Çπ„Éà„É™„Éº„É†„Çí„Éì„Éá„Ç™„Çπ„Éà„É™„Éº„É†„Å´ËøΩÂä†
                dest.stream.getAudioTracks().forEach(track => {
                    stream.addTrack(track);
                });
                
                updateProgress(20);
                
                console.log('üìº MediaRecorder„ÇíÂàùÊúüÂåñ‰∏≠...');
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp8,opus'
                });
                
                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                        console.log(`üì¶ „Éá„Éº„Çø„ÉÅ„É£„É≥„ÇØÂèó‰ø°: ${e.data.size}„Éê„Ç§„Éà`);
                    }
                };
                
                // ÁîªÂÉè„Çí„Éó„É™„É≠„Éº„Éâ
                console.log('üîÑ „Çπ„É©„Ç§„ÉâÁîªÂÉè„Çí„Éó„É™„É≠„Éº„Éâ‰∏≠...');
                const images = [];
                for (let i = 0; i < slideImages.length; i++) {
                    console.log(`üì∏ „Çπ„É©„Ç§„Éâ ${i + 1}/${slideImages.length} „Çí„É≠„Éº„Éâ‰∏≠...`);
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = () => {
                            console.log(`‚úÖ „Çπ„É©„Ç§„Éâ ${i + 1} „É≠„Éº„ÉâÂÆå‰∫Ü`);
                            resolve();
                        };
                        img.onerror = reject;
                        img.src = URL.createObjectURL(slideImages[i]);
                    });
                    images.push(img);
                    updateProgress(20 + (i / slideImages.length) * 30);
                }
                
                updateProgress(50);
                console.log('üéµ Èü≥Â£∞ÂÜçÁîü„Å®Èå≤Áîª„ÇíÈñãÂßã„Åó„Åæ„Åô...');
                showStatus('üéµ Èü≥Â£∞ÂÜçÁîü„Å®Èå≤Áîª„ÇíÈñãÂßã„Åó„Åæ„Åô...', 'info');
                
                // Èå≤ÁîªÈñãÂßã
                mediaRecorder.start();
                audioElement.play();
                
                const totalDuration = Math.max(...timing.map(t => t.end_ms));
                console.log(`‚è±Ô∏è Á∑èÂãïÁîªÊôÇÈñì: ${totalDuration}ms (${totalDuration/1000}Áßí)`);
                const startTime = Date.now();
                
                let frameCount = 0;
                let lastLogTime = 0;
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó
                function animate() {
                    const currentTime = Date.now() - startTime;
                    frameCount++;
                    
                    // 1Áßí„Åî„Å®„Å´„É≠„Ç∞Âá∫Âäõ
                    if (currentTime - lastLogTime >= 1000) {
                        const fps = frameCount / (currentTime / 1000);
                        console.log(`üé• Èå≤Áîª‰∏≠: ${(currentTime/1000).toFixed(1)}s / ${(totalDuration/1000).toFixed(1)}s (${fps.toFixed(1)} FPS)`);
                        lastLogTime = currentTime;
                    }
                    
                    if (currentTime >= totalDuration) {
                        // Èå≤ÁîªÁµÇ‰∫Ü
                        console.log('‚èπÔ∏è Èå≤ÁîªÁµÇ‰∫ÜÂá¶ÁêÜ„ÇíÈñãÂßã...');
                        mediaRecorder.stop();
                        audioElement.pause();
                        return;
                    }
                    
                    // ÁèæÂú®Ë°®Á§∫„Åô„Åπ„ÅçÁîªÂÉè„ÇíÊ±∫ÂÆö
                    let currentImageIndex = 0;
                    for (let i = 0; i < timing.length; i++) {
                        if (currentTime >= timing[i].start_ms && currentTime < timing[i].end_ms) {
                            currentImageIndex = i;
                            break;
                        }
                    }
                    
                    // ÁîªÂÉè„ÇíÊèèÁîª
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    if (images[currentImageIndex]) {
                        // ÁîªÂÉè„Çí‰∏≠Â§Æ„Å´ÈÖçÁΩÆ
                        const img = images[currentImageIndex];
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                        const x = (canvas.width - img.width * scale) / 2;
                        const y = (canvas.height - img.height * scale) / 2;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    }
                    
                    // ÈÄ≤ÊçóÊõ¥Êñ∞
                    const progress = 50 + (currentTime / totalDuration) * 45;
                    updateProgress(progress);
                    
                    requestAnimationFrame(animate);
                }
                
                animate();
                
                // Èå≤ÁîªÂÆå‰∫ÜÂá¶ÁêÜ
                mediaRecorder.onstop = async () => {
                    console.log('üéûÔ∏è ÂãïÁîª„Éï„Ç°„Ç§„É´ÁîüÊàê‰∏≠...');
                    updateProgress(95);
                    showStatus('üéûÔ∏è ÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info');
                    
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    console.log(`üìÅ ÂãïÁîª„Éï„Ç°„Ç§„É´ÁîüÊàêÂÆå‰∫Ü: ${(blob.size / 1024 / 1024).toFixed(2)}MB`);
                    
                    // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
                    const preview = document.getElementById('preview');
                    const videoPreview = document.getElementById('videoPreview');
                    const downloadLink = document.getElementById('downloadLink');
                    
                    videoPreview.src = url;
                    downloadLink.href = url;
                    downloadLink.download = 'slides_video.webm';
                    downloadLink.style.display = 'inline-flex';
                    preview.style.display = 'block';
                    
                    updateProgress(100);
                    console.log('üéâ ÂãïÁîª‰ΩúÊàêÂÆå‰∫ÜÔºÅ');
                    showStatus('‚úÖ ÂãïÁîª„ÅÆ‰ΩúÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                    
                    // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'üé¨ ÂãïÁîª„Çí‰ΩúÊàê„Åô„Çã';
                    
                    // „É°„É¢„É™„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                    console.log('üßπ „É°„É¢„É™„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó‰∏≠...');
                    images.forEach(img => URL.revokeObjectURL(img.src));
                    URL.revokeObjectURL(audioElement.src);
                    
                    audioContext.close();
                    console.log('‚ú® ÂÖ®Âá¶ÁêÜÂÆå‰∫Ü');
                };
                
            } catch (error) {
                console.error('‚ùå ÂãïÁîª‰ΩúÊàê„Ç®„É©„Éº:', error);
                showStatus(`‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`, 'error');
                
                const createBtn = document.getElementById('createVideoBtn');
                createBtn.disabled = false;
                createBtn.innerHTML = 'üé¨ ÂãïÁîª„Çí‰ΩúÊàê„Åô„Çã';
            }
        }
    </script>
</body>
</html>
