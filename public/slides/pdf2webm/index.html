<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFå‹•ç”»ä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .section:hover {
            transform: translateY(-2px);
        }
        
        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
        }
        
        .file-input {
            width: 100%;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .file-input:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-input.drag-over {
            border-color: #667eea;
            background: #e8f2ff;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .file-input.drag-over .file-input-text {
            color: #667eea;
            font-weight: 600;
        }
        
        .file-input input {
            display: none !important;
        }
        
        .file-input-text {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            resize: vertical;
            transition: all 0.3s ease;
            position: relative;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea.drag-over {
            border-color: #667eea;
            background: #f8fbff;
            transform: scale(1.01);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .preview {
            margin-top: 30px;
            text-align: center;
        }
        
        .preview video {
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }
        
        .file-item {
            padding: 8px 12px;
            background: white;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            margin-bottom: -2px;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .url-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .load-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .load-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .load-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .global-drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.1);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .global-drop-overlay.active {
            display: flex;
        }
        
        .drop-message {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
            border: 3px dashed #667eea;
        }
    </style>
</head>
<body>
    <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="globalDropOverlay" class="global-drop-overlay">
        <div class="drop-message">
            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„
        </div>
    </div>
    
    <div class="container">
        <h1>ğŸ“½ï¸ PDFå‹•ç”»ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="section">
            <h2>
                <span class="icon">ğŸ“„</span>
                PDFãƒ•ã‚¡ã‚¤ãƒ« (ã‚¹ãƒ©ã‚¤ãƒ‰)
            </h2>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('file')">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <button class="tab" onclick="switchTab('url')">ğŸ”— Googleã‚¹ãƒ©ã‚¤ãƒ‰URL</button>
            </div>
            
            <div id="fileTab" class="tab-content active">
                <div class="file-input" onclick="document.getElementById('pdfFile').click()">
                    <input type="file" id="pdfFile" accept="application/pdf,.pdf" />
                    <div class="file-input-text">ğŸ“ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
                </div>
            </div>
            
            <div id="urlTab" class="tab-content">
                <input type="url" class="url-input" id="pdfUrl" placeholder="https://docs.google.com/presentation/d/your-slide-id/edit ã¾ãŸã¯ export?format=pdf" />
                <button class="load-btn" id="loadUrlBtn" onclick="loadPdfFromUrl()">ğŸ“¥ PDFå‡ºåŠ›URLã‚’ç”Ÿæˆãƒ»å–å¾—</button>
                <div style="margin-top: 10px; font-size: 12px; color: #666; line-height: 1.4;">
                    ğŸ’¡ ãƒ’ãƒ³ãƒˆ: Googleã‚¹ãƒ©ã‚¤ãƒ‰ã®URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã€PDFå‡ºåŠ›ç”¨ã®URLã‚’ç”Ÿæˆã—ã¾ã™ã€‚<br>
                    CORSåˆ¶é™ã«ã‚ˆã‚Šã€ç”Ÿæˆã•ã‚ŒãŸURLã‹ã‚‰æ‰‹å‹•ã§PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‚¿ãƒ–ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            
            <div id="pdfFileName" class="file-list" style="display: none;"></div>
            <div id="slidePreview" class="file-list" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>
                <span class="icon">ğŸµ</span>
                éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« (MP3)
            </h2>
            <div class="file-input" onclick="document.getElementById('audioFile').click()">
                <input type="file" id="audioFile" accept="audio/mp3,.mp3" />
                <div class="file-input-text">ğŸ¶ MP3éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
            </div>
            <div id="audioFileName" class="file-list" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>
                <span class="icon">â±ï¸</span>
                ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ± (JSON)
            </h2>
            <textarea id="timingJson" placeholder='[
  {"start_ms": 0, "end_ms": 3000},
  {"start_ms": 3000, "end_ms": 6000},
  {"start_ms": 6000, "end_ms": 9000}
]

å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®é–‹å§‹æ™‚é–“(start_ms)ã¨çµ‚äº†æ™‚é–“(end_ms)ã‚’ãƒŸãƒªç§’ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
ğŸ’¡ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦èª­ã¿è¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ã€‚'></textarea>
        </div>
        
        <button class="btn" id="createVideoBtn" onclick="createVideo()">
            ğŸ¬ å‹•ç”»ã‚’ä½œæˆã™ã‚‹
        </button>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="status"></div>
        
        <div class="preview" id="preview" style="display: none;">
            <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <video controls id="videoPreview"></video>
            <br><br>
            <a id="downloadLink" class="btn" style="display: none; text-decoration: none;">
                ğŸ’¾ å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let pdfFile = null;
        let slideImages = [];
        let audioFile = null;
        let currentPdfSource = null; // 'file' or 'url'
        
        function switchTab(tabType) {
            // ã‚¿ãƒ–ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            if (tabType === 'file') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('fileTab').classList.add('active');
            } else if (tabType === 'url') {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('urlTab').classList.add('active');
            }
        }
        
        async function loadPdfFromUrl() {
            const urlInput = document.getElementById('pdfUrl');
            const loadBtn = document.getElementById('loadUrlBtn');
            const url = urlInput.value.trim();
            
            if (!url) {
                showStatus('âŒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // URLã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
            if (!url.includes('docs.google.com')) {
                showStatus('âŒ Googleã‚¹ãƒ©ã‚¤ãƒ‰ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                loadBtn.disabled = true;
                loadBtn.textContent = 'ğŸ“¥ èª­ã¿è¾¼ã¿ä¸­...';
                showStatus('ğŸ”— URLã‹ã‚‰PDFã‚’å–å¾—ã—ã¦ã„ã¾ã™...', 'info');
                
                // Googleã‚¹ãƒ©ã‚¤ãƒ‰ã®URLã‚’PDFå‡ºåŠ›URLã«å¤‰æ›
                let pdfUrl = url;
                if (url.includes('/edit')) {
                    // ç·¨é›†URLã®å ´åˆã€PDFå‡ºåŠ›URLã«å¤‰æ›
                    const slideId = url.match(/\/presentation\/d\/([a-zA-Z0-9-_]+)/);
                    if (slideId) {
                        pdfUrl = `https://docs.google.com/presentation/d/${slideId[1]}/export?format=pdf`;
                    }
                }
                
                // ãƒ–ãƒ©ã‚¦ã‚¶ã§PDFã‚’ç›´æ¥å–å¾—ã‚’è©¦ã¿ã‚‹
                try {
                    const response = await fetch(pdfUrl, {
                        mode: 'no-cors'
                    });
                    
                    // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯æˆåŠŸã—ãŸã‹ã©ã†ã‹ã‚ã‹ã‚‰ãªã„ãŸã‚ã€
                    // ã‚ˆã‚Šç›´æ¥çš„ãªæ–¹æ³•ã‚’æ¡ˆå†…
                    showStatus('â„¹ï¸ CORSåˆ¶é™ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®æ‰‹é †ã§PDFã‚’å–å¾—ã—ã¦ãã ã•ã„ï¼š\n1. ä¸Šè¨˜ã®URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã\n2. PDFãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ã€ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‚¿ãƒ–ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', 'info');
                    
                    // URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    try {
                        await navigator.clipboard.writeText(pdfUrl);
                        showStatus('âœ… PDFå‡ºåŠ›URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã„ã¦PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'success');
                    } catch (e) {
                        console.log('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', e);
                    }
                    
                    // æ–°ã—ã„ã‚¿ãƒ–ã§PDFã‚’é–‹ã
                    window.open(pdfUrl, '_blank');
                    
                } catch (fetchError) {
                    console.error('Fetch error:', fetchError);
                    
                    // ãƒ•ã‚§ãƒƒãƒãŒå¤±æ•—ã—ãŸå ´åˆã‚‚ã€URLã‚’æä¾›
                    showStatus('â„¹ï¸ ç›´æ¥å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã®æ‰‹é †ã§PDFã‚’å–å¾—ã—ã¦ãã ã•ã„ï¼š\n1. ä¸‹è¨˜URLã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã\n2. PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\n3. ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‚¿ãƒ–ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', 'info');
                    
                    // URLã‚’è¡¨ç¤º
                    const pdfFileName = document.getElementById('pdfFileName');
                    pdfFileName.style.display = 'block';
                    pdfFileName.innerHTML = `
                        <div class="file-item" style="flex-direction: column; align-items: flex-start;">
                            <div style="margin-bottom: 10px;">ğŸ“‹ PDFå‡ºåŠ›URL:</div>
                            <div style="word-break: break-all; background: #f0f0f0; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                                ${pdfUrl}
                            </div>
                            <button onclick="window.open('${pdfUrl}', '_blank')" style="margin-top: 8px; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ğŸ“‚ æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('âŒ URLå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`âŒ URLå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'ğŸ“¥ URLã‹ã‚‰PDFã‚’èª­ã¿è¾¼ã¿';
            }
        }
        
        document.getElementById('pdfFile').addEventListener('change', function(e) {
            pdfFile = e.target.files[0];
            currentPdfSource = 'file';
            updatePdfFileName();
            if (pdfFile) {
                processPDF();
            }
        });
        
        document.getElementById('audioFile').addEventListener('change', function(e) {
            audioFile = e.target.files[0];
            updateAudioFileName();
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã®åˆæœŸåŒ–
        initializeDragAndDrop();
        
        function initializeDragAndDrop() {
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            initializeGlobalDragAndDrop();
            
            // PDFãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            const pdfDropZone = document.querySelector('#fileTab .file-input');
            setupDragAndDrop(pdfDropZone, 'pdf', handlePdfDrop);
            
            // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            const audioDropZone = document.querySelector('.section:nth-child(3) .file-input');
            setupDragAndDrop(audioDropZone, 'audio', handleAudioDrop);
            
            // JSONãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆtextareaï¼‰
            const jsonDropZone = document.getElementById('timingJson');
            setupDragAndDrop(jsonDropZone, 'json', handleJsonDrop);
        }
        
        function initializeGlobalDragAndDrop() {
            const overlay = document.getElementById('globalDropOverlay');
            let dragCounter = 0;
            
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã¸ã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
            document.addEventListener('dragenter', function(e) {
                e.preventDefault();
                dragCounter++;
                if (dragCounter === 1) {
                    overlay.classList.add('active');
                }
            });
            
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã‹ã‚‰ã®ãƒ‰ãƒ©ãƒƒã‚°é›¢è„±
            document.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) {
                    overlay.classList.remove('active');
                }
            });
            
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã§ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã§ã®ãƒ‰ãƒ­ãƒƒãƒ—
            document.addEventListener('drop', function(e) {
                e.preventDefault();
                dragCounter = 0;
                overlay.classList.remove('active');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleGlobalFileDrop(files[0]);
                }
            });
        }
        
        function handleGlobalFileDrop(file) {
            const fileName = file.name.toLowerCase();
            const fileType = file.type;
            
            if (fileName.endsWith('.pdf') || fileType.includes('pdf')) {
                handlePdfDrop(file);
            } else if (fileName.endsWith('.mp3') || fileType.includes('audio')) {
                handleAudioDrop(file);
            } else if (fileName.endsWith('.json') || fileName.endsWith('.txt') || fileType.includes('json') || fileType.includes('text')) {
                handleJsonDrop(file);
            } else {
                showStatus('âŒ ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚PDFã€MP3ã€ã¾ãŸã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        }
        
        function setupDragAndDrop(dropZone, fileType, handleDrop) {
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®å¤–ã«å‡ºãŸæ™‚ã®ã¿ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                }
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleDrop(files[0]);
                }
            });
        }
        
        function handlePdfDrop(file) {
            // PDFãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
            if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
                showStatus('âŒ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            pdfFile = file;
            currentPdfSource = 'file';
            updatePdfFileName();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            switchTab('file');
            
            showStatus('âœ… PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ', 'success');
            processPDF();
        }
        
        function handleAudioDrop(file) {
            // MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
            if (!file.type.includes('audio') && !file.name.toLowerCase().endsWith('.mp3')) {
                showStatus('âŒ MP3éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            audioFile = file;
            updateAudioFileName();
            showStatus('âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ', 'success');
        }
        
        function handleJsonDrop(file) {
            // JSONã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
            if (!file.type.includes('json') && !file.type.includes('text') && 
                !file.name.toLowerCase().endsWith('.json') && 
                !file.name.toLowerCase().endsWith('.txt')) {
                showStatus('âŒ JSONã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    // JSONã®å½¢å¼ãƒã‚§ãƒƒã‚¯
                    JSON.parse(content);
                    document.getElementById('timingJson').value = content;
                    showStatus('âœ… ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'success');
                } catch (error) {
                    // JSONå½¢å¼ã§ãªã„å ´åˆã€ãã®ã¾ã¾ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æŒ¿å…¥
                    document.getElementById('timingJson').value = content;
                    showStatus('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒæŒ¿å…¥ã•ã‚Œã¾ã—ãŸï¼ˆJSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'info');
                }
            };
            reader.readAsText(file);
        }
        
        async function processPDF() {
            if (pdfFile) {
                await processPDFFromFile(pdfFile);
            }
        }
        
        async function processPDFFromFile(file) {
            const arrayBuffer = await file.arrayBuffer();
            await processPDFFromBuffer(arrayBuffer, file.name);
        }
        
        async function processPDFFromBlob(blob, filename) {
            const arrayBuffer = await blob.arrayBuffer();
            await processPDFFromBuffer(arrayBuffer, filename);
        }
        
        async function processPDFFromBuffer(arrayBuffer, filename) {
            try {
                console.log('ğŸ“„ PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™:', filename);
                showStatus('ğŸ“„ PDFã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'info');
                
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const numPages = pdf.numPages;
                
                console.log(`ğŸ“Š PDFãƒšãƒ¼ã‚¸æ•°: ${numPages}`);
                showStatus(`ğŸ“Š ${numPages}ãƒšãƒ¼ã‚¸ã®PDFã‚’å‡¦ç†ä¸­...`, 'info');
                
                slideImages = [];
                const slidePreview = document.getElementById('slidePreview');
                slidePreview.innerHTML = '';
                slidePreview.style.display = 'block';
                
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    console.log(`ğŸ”„ ãƒšãƒ¼ã‚¸ ${pageNum}/${numPages} ã‚’å‡¦ç†ä¸­...`);
                    showStatus(`ğŸ”„ ãƒšãƒ¼ã‚¸ ${pageNum}/${numPages} ã‚’PNGå¤‰æ›ä¸­...`, 'info');
                    
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 2.0 });
                    
                    // Canvasä½œæˆ
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    // PDFãƒšãƒ¼ã‚¸ã‚’Canvasã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    }).promise;
                    
                    // Canvasã‚’Blobã«å¤‰æ›
                    const blob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/png');
                    });
                    
                    slideImages.push(blob);
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚µãƒ ãƒã‚¤ãƒ«ä½œæˆ
                    const thumbnailCanvas = document.createElement('canvas');
                    const thumbnailCtx = thumbnailCanvas.getContext('2d');
                    const thumbnailScale = 150 / Math.max(viewport.width, viewport.height);
                    thumbnailCanvas.width = viewport.width * thumbnailScale;
                    thumbnailCanvas.height = viewport.height * thumbnailScale;
                    
                    thumbnailCtx.drawImage(canvas, 0, 0, thumbnailCanvas.width, thumbnailCanvas.height);
                    
                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'file-item';
                    thumbnailDiv.style.display = 'flex';
                    thumbnailDiv.style.alignItems = 'center';
                    thumbnailDiv.style.gap = '10px';
                    thumbnailDiv.innerHTML = `
                        <span>ğŸ“„ ã‚¹ãƒ©ã‚¤ãƒ‰ ${pageNum}</span>
                        <span style="font-size: 12px; color: #888;">${canvas.width}Ã—${canvas.height}px</span>
                    `;
                    thumbnailDiv.appendChild(thumbnailCanvas);
                    thumbnailCanvas.style.borderRadius = '4px';
                    slidePreview.appendChild(thumbnailDiv);
                    
                    console.log(`âœ… ãƒšãƒ¼ã‚¸ ${pageNum} å®Œäº† (${canvas.width}Ã—${canvas.height}px)`);
                }
                
                console.log(`ğŸ‰ PDFå‡¦ç†å®Œäº†: ${slideImages.length}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒã‚’ç”Ÿæˆ`);
                showStatus(`âœ… PDFå‡¦ç†å®Œäº†: ${slideImages.length}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`, 'success');
                
            } catch (error) {
                console.error('âŒ PDFå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`âŒ PDFå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        function updatePdfFileName(filename = null, filesize = null) {
            const pdfFileName = document.getElementById('pdfFileName');
            if (currentPdfSource === 'file' && pdfFile) {
                pdfFileName.style.display = 'block';
                pdfFileName.innerHTML = `<div class="file-item">ğŸ“„ ${pdfFile.name} (${Math.round(pdfFile.size/1024)}KB)</div>`;
            } else if (currentPdfSource === 'url' && filename) {
                pdfFileName.style.display = 'block';
                const sizeText = filesize ? `(${Math.round(filesize/1024)}KB)` : '';
                pdfFileName.innerHTML = `<div class="file-item">ğŸ“„ ${filename} ${sizeText}</div>`;
            } else {
                pdfFileName.style.display = 'none';
            }
        }
        
        function updateAudioFileName() {
            const audioFileName = document.getElementById('audioFileName');
            if (audioFile) {
                audioFileName.style.display = 'block';
                audioFileName.innerHTML = `<div class="file-item">ğŸµ ${audioFile.name} (${Math.round(audioFile.size/1024)}KB)</div>`;
            } else {
                audioFileName.style.display = 'none';
            }
        }
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateProgress(percent) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';
        }
        
        async function createVideo() {
            try {
                console.log('ğŸ¬ å‹•ç”»ä½œæˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');
                
                // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
                if (slideImages.length === 0) {
                    console.error('âŒ ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    showStatus('âŒ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                if (!audioFile) {
                    console.error('âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    showStatus('âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                let timing;
                try {
                    timing = JSON.parse(document.getElementById('timingJson').value);
                    console.log('ğŸ“‹ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±:', timing);
                } catch (e) {
                    console.error('âŒ JSONè§£æã‚¨ãƒ©ãƒ¼:', e);
                    showStatus('âŒ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã®JSONãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
                
                if (!Array.isArray(timing) || timing.length !== slideImages.length) {
                    console.error(`âŒ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ•°(${timing.length})ã¨ã‚¹ãƒ©ã‚¤ãƒ‰æ•°(${slideImages.length})ãŒä¸ä¸€è‡´`);
                    showStatus(`âŒ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã®æ•°(${timing.length})ã¨ã‚¹ãƒ©ã‚¤ãƒ‰æ•°(${slideImages.length})ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚`, 'error');
                    return;
                }
                
                // start_ms, end_msãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç¢ºèª
                const hasValidTiming = timing.every(t => 
                    typeof t.start_ms === 'number' && typeof t.end_ms === 'number'
                );
                if (!hasValidTiming) {
                    console.error('âŒ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã«start_msã¾ãŸã¯end_msãŒä¸è¶³');
                    showStatus('âŒ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã«start_msã¨end_msã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                const createBtn = document.getElementById('createVideoBtn');
                createBtn.disabled = true;
                createBtn.innerHTML = 'ğŸ¬ å‹•ç”»ä½œæˆä¸­...';
                
                console.log('ğŸ¬ å‹•ç”»ä½œæˆã‚’é–‹å§‹ã—ã¾ã™...');
                showStatus('ğŸ¬ å‹•ç”»ä½œæˆã‚’é–‹å§‹ã—ã¾ã™...', 'info');
                updateProgress(0);
                
                // Canvasè¨­å®š
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // æœ€åˆã®ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’èª¿æ•´
                console.log('ğŸ–¼ï¸ æœ€åˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const firstImg = new Image();
                await new Promise((resolve, reject) => {
                    firstImg.onload = resolve;
                    firstImg.onerror = reject;
                    firstImg.src = URL.createObjectURL(slideImages[0]);
                });
                
                canvas.width = firstImg.width;
                canvas.height = firstImg.height;
                console.log(`ğŸ“ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º: ${canvas.width}Ã—${canvas.height}`);
                
                updateProgress(10);
                
                // MediaRecorder setup
                console.log('ğŸ“¹ ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åˆæœŸåŒ–ä¸­...');
                const stream = canvas.captureStream(30); // 30fps
                
                // éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¿½åŠ 
                console.log('ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ä¸­...');
                const audioElement = new Audio();
                audioElement.src = URL.createObjectURL(audioFile);
                
                await new Promise((resolve, reject) => {
                    audioElement.oncanplaythrough = () => {
                        console.log(`ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†: ${audioElement.duration}ç§’`);
                        resolve();
                    };
                    audioElement.onerror = reject;
                    audioElement.load();
                });
                
                // AudioContextã§éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œæˆ
                console.log('ğŸ”Š AudioContextåˆæœŸåŒ–ä¸­...');
                const audioContext = new AudioContext();
                const source = audioContext.createMediaElementSource(audioElement);
                const dest = audioContext.createMediaStreamDestination();
                source.connect(dest);
                source.connect(audioContext.destination);
                
                // éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã«è¿½åŠ 
                dest.stream.getAudioTracks().forEach(track => {
                    stream.addTrack(track);
                });
                
                updateProgress(20);
                
                console.log('ğŸ“¼ MediaRecorderã‚’åˆæœŸåŒ–ä¸­...');
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp8,opus'
                });
                
                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                        console.log(`ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒ³ã‚¯å—ä¿¡: ${e.data.size}ãƒã‚¤ãƒˆ`);
                    }
                };
                
                // ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
                console.log('ğŸ”„ ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ä¸­...');
                const images = [];
                for (let i = 0; i < slideImages.length; i++) {
                    console.log(`ğŸ“¸ ã‚¹ãƒ©ã‚¤ãƒ‰ ${i + 1}/${slideImages.length} ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...`);
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = () => {
                            console.log(`âœ… ã‚¹ãƒ©ã‚¤ãƒ‰ ${i + 1} ãƒ­ãƒ¼ãƒ‰å®Œäº†`);
                            resolve();
                        };
                        img.onerror = reject;
                        img.src = URL.createObjectURL(slideImages[i]);
                    });
                    images.push(img);
                    updateProgress(20 + (i / slideImages.length) * 30);
                }
                
                updateProgress(50);
                console.log('ğŸµ éŸ³å£°å†ç”Ÿã¨éŒ²ç”»ã‚’é–‹å§‹ã—ã¾ã™...');
                showStatus('ğŸµ éŸ³å£°å†ç”Ÿã¨éŒ²ç”»ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
                
                // éŒ²ç”»é–‹å§‹
                mediaRecorder.start();
                audioElement.play();
                
                const totalDuration = Math.max(...timing.map(t => t.end_ms));
                console.log(`â±ï¸ ç·å‹•ç”»æ™‚é–“: ${totalDuration}ms (${totalDuration/1000}ç§’)`);
                const startTime = Date.now();
                
                let frameCount = 0;
                let lastLogTime = 0;
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
                function animate() {
                    const currentTime = Date.now() - startTime;
                    frameCount++;
                    
                    // 1ç§’ã”ã¨ã«ãƒ­ã‚°å‡ºåŠ›
                    if (currentTime - lastLogTime >= 1000) {
                        const fps = frameCount / (currentTime / 1000);
                        console.log(`ğŸ¥ éŒ²ç”»ä¸­: ${(currentTime/1000).toFixed(1)}s / ${(totalDuration/1000).toFixed(1)}s (${fps.toFixed(1)} FPS)`);
                        lastLogTime = currentTime;
                    }
                    
                    if (currentTime >= totalDuration) {
                        // éŒ²ç”»çµ‚äº†
                        console.log('â¹ï¸ éŒ²ç”»çµ‚äº†å‡¦ç†ã‚’é–‹å§‹...');
                        mediaRecorder.stop();
                        audioElement.pause();
                        return;
                    }
                    
                    // ç¾åœ¨è¡¨ç¤ºã™ã¹ãç”»åƒã‚’æ±ºå®š
                    let currentImageIndex = 0;
                    for (let i = 0; i < timing.length; i++) {
                        if (currentTime >= timing[i].start_ms && currentTime < timing[i].end_ms) {
                            currentImageIndex = i;
                            break;
                        }
                    }
                    
                    // ç”»åƒã‚’æç”»
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    if (images[currentImageIndex]) {
                        // ç”»åƒã‚’ä¸­å¤®ã«é…ç½®
                        const img = images[currentImageIndex];
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                        const x = (canvas.width - img.width * scale) / 2;
                        const y = (canvas.height - img.height * scale) / 2;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    }
                    
                    // é€²æ—æ›´æ–°
                    const progress = 50 + (currentTime / totalDuration) * 45;
                    updateProgress(progress);
                    
                    requestAnimationFrame(animate);
                }
                
                animate();
                
                // éŒ²ç”»å®Œäº†å‡¦ç†
                mediaRecorder.onstop = async () => {
                    console.log('ğŸï¸ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­...');
                    updateProgress(95);
                    showStatus('ğŸï¸ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...', 'info');
                    
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    console.log(`ğŸ“ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº†: ${(blob.size / 1024 / 1024).toFixed(2)}MB`);
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    const preview = document.getElementById('preview');
                    const videoPreview = document.getElementById('videoPreview');
                    const downloadLink = document.getElementById('downloadLink');
                    
                    videoPreview.src = url;
                    downloadLink.href = url;
                    downloadLink.download = 'slides_video.webm';
                    downloadLink.style.display = 'inline-flex';
                    preview.style.display = 'block';
                    
                    updateProgress(100);
                    console.log('ğŸ‰ å‹•ç”»ä½œæˆå®Œäº†ï¼');
                    showStatus('âœ… å‹•ç”»ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                    
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'ğŸ¬ å‹•ç”»ã‚’ä½œæˆã™ã‚‹';
                    
                    // ãƒ¡ãƒ¢ãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    console.log('ğŸ§¹ ãƒ¡ãƒ¢ãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...');
                    images.forEach(img => URL.revokeObjectURL(img.src));
                    URL.revokeObjectURL(audioElement.src);
                    
                    audioContext.close();
                    console.log('âœ¨ å…¨å‡¦ç†å®Œäº†');
                };
                
            } catch (error) {
                console.error('âŒ å‹•ç”»ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                
                const createBtn = document.getElementById('createVideoBtn');
                createBtn.disabled = false;
                createBtn.innerHTML = 'ğŸ¬ å‹•ç”»ã‚’ä½œæˆã™ã‚‹';
            }
        }
    </script>
</body>
</html>
